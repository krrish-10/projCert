version: '3.8'

services:
  jenkins-slave:
    image: jenkins-slave:latest
    container_name: jenkins-slave-1
    hostname: jenkins-slave-1
    ports:
      - "2222:22"
    environment:
      - JENKINS_AGENT_SSH_PUBKEY=${JENKINS_AGENT_SSH_PUBKEY}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for DinD
      - slave_workspace:/home/jenkins/workspace
      - ${HOME}/.ssh/id_rsa:/home/jenkins/.ssh/id_rsa:ro  # Optional: use your Mac SSH key
    networks:
      - jenkins-network
    restart: unless-stopped
    command: |
      bash -c "
        service ssh start && \
        echo '${JENKINS_AGENT_SSH_PUBKEY}' > /home/jenkins/.ssh/authorized_keys && \
        chmod 600 /home/jenkins/.ssh/authorized_keys && \
        chown jenkins:jenkins /home/jenkins/.ssh/authorized_keys && \
        tail -f /dev/null
      "

volumes:
  slave_workspace: projcert_jenkins-slave-workspace

networks:
  jenkins-network:
    driver: bridge
